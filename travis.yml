language: generic

cache:
  - pip

sudo: required

dist: trusty

branches:
  only:
    - 6.0.0

notifications:
  email: false

env:
  global:
    # used by ci-helpers
    - SETUP_XVFB=true
    - PIP_DEPENDENCIES='hacking pytest pytest-qt requests pytest-mock beautifulsoup4'
    - MPLBACKEND=TkAgg  # for osx
matrix:
  include:
    - os: osx
      env:
        - PYTEST_QT_API=pyqt5
        - PYQT_PACKAGE='pyqt=5'
        - PYTHON_VERSION=3.6
        - RUN_PYINSTALLER=true
    - os: linux
      dist: trusty
      env:
        - PYTEST_QT_API=pyqt5
        - PYQT_PACKAGE='pyqt=5'
        - PYTHON_VERSION=3.6
        - RUN_PYINSTALLER=true

install:
  # Setup X
  - |
    if [ $TRAVIS_OS_NAME = "linux" ]; then
      sudo apt-get update
      # Xvfb / window manager
      sudo apt-get install -y xvfb herbstluftwm
    elif [ $TRAVIS_OS_NAME = "osx" ]; then
      brew cask install xquartz
    fi
  # Setup miniconda
  - git clone --depth 1 git://github.com/astropy/ci-helpers.git
  - CONDA_DEPENDENCIES=$PYQT_PACKAGE source ci-helpers/travis/setup_conda.sh
  - source activate test && export LD_LIBRARY_PATH=$CONDA_PREFIX/lib:$LD_LIBRARY_PATH
  - pip install .
  - rm -rf ci-helpers miniconda.sh

before_script:
  - if [ $TRAVIS_OS_NAME = "linux" ]; then (herbstluftwm )& fi
  - if [ $TRAVIS_OS_NAME = "osx" ]; then (sudo Xvfb :99 -ac -screen 0 1024x768x8 )& fi
  - echo 'XXXXXXXX'
  - pwd
  - sleep 1

script:
  # Run pytest
  - pytest -v tests
